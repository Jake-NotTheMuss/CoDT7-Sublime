%YAML 1.2
---
# http://www.sublimetext.com/docs/3/syntax.html

# This file is part of the T7-Sublime project.
# T7-Sublime is an enhanced syntax-highlighting package for (almost) all Call of Duty Black Ops III developer file formats.
# Zone Dependency files contain dependency information used for zone builds.

name: Zone Dependencies
hidden: true
file_extensions:
  - deps
scope: text.codt7.zonedeps
extends: 'Packages/CoDT7 Formats/Zone.sublime-syntax'

variables:
  meta_info_keys: 'version|errorcount|assetlist'
  dep_keys: 'file|spawn'

contexts:
  main:
    - include: global
    - include: scope:source.codt7.common#comments

  global:
    - include: meta-info
    - include: meta-directives
    - include: assets

  meta-info:
    - match: '^\s*(?=({{meta_info_keys}})\b)'
      push:
        - meta_content_scope: meta.info-line.codt7.zonedeps
        - match: $\n
          pop: true
        - match: '(assetlist)\s*(,)\s*(\w+)$'
          captures:
            1: support.constant.codt7.zonedeps markup.italic
            2: punctuation.separator.codt7.zonedeps
            3: constant.other.codt7.zonedeps
        - match: '\b({{meta_info_keys}})\b'
          scope: support.constant.codt7.zonedeps markup.italic
        - include: non-words

  non-words:
    - match: ','
      scope: punctuation.separator.codt7.zonedeps
    - include: numbers

  assets:
    - match: '^\s*(?=({{all_types}})\b)'
      push:
        - meta_content_scope: meta.dependency-header.codt7.zonedeps
        - match: $\n
          pop: true
        - include: asset-type
        - match: ','
          scope: punctuation.separator.codt7.zonedeps
          set:
            - meta_content_scope: meta.dependency-header.codt7.zonedeps entity.name.asset.codt7.zonedeps
            - match: $\n
              pop: true
            - match: ','
              scope: invalid.illegal.unexpected-character.codt7.zonedeps
    - match: '^\s*(?=({{dep_keys}})\b)'
      push:
        - meta_content_scope: meta.dependency-item.codt7.zonedeps
        - match: $\n
          pop: true
        - match: '(?=file\b)'
          set: dep-type-file
        - match: '(?=spawn\b)'
          set: dep-type-spawn

  dep-type-common:
    - match: '\b{{dep_keys}}\b'
      scope: support.constant.codt7.zonedeps markup.italic

  dep-type-file:
    - meta_content_scope: meta.dependency-item.file.codt7.zonedeps
    - match: $\n
      pop: true
    - include: dep-type-common
    - match: ','
      scope: punctuation.separator.codt7.zonedeps
      set: file-name

  file-name:
    - meta_content_scope: meta.dependency-item.codt7.zonedeps entity.name.filename.codt7.zonedeps
    - match: $\n
      pop: true
    - match: '(?=,|$)'
      set: comma-separated-numbers

  comma-separated-numbers:
    - meta_content_scope: meta.dependency-item.codt7.zonedeps
    - match: $\n
      pop: true
    - match: ','
      scope: punctuation.separator.codt7.zonedeps
      push:
        - meta_content_scope: constant.numeric.value.codt7.zonedeps
        - match: '(?=,|$)'
          pop: true
        - match: '[^\h\.]'
          scope: invalid.illegal.unexpected-character.codt7.zonedeps

  dep-type-spawn:
    - meta_content_scope: meta.dependency-item.spawn.codt7.zonedeps
    - match: $\n
      pop: true
    - include: dep-type-common
    - match: ','
      scope: punctuation.separator.codt7.zonedeps
    - match: '\b({{header_identifiers}})\b'
      scope: keyword.other markup.italic
